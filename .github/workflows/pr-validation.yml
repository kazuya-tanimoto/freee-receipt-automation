name: Pull Request Validation

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened, ready_for_review ]

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # PRの全ての変更を取得するため
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'yarn'
        
    - name: Install dependencies
      run: yarn install --frozen-lockfile
      
    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v41
      with:
        files: |
          **/*.md
          **/*.ts
          **/*.tsx
          **/*.js
          **/*.jsx
          
    - name: Validate markdown files
      if: steps.changed-files.outputs.any_changed == 'true' && contains(steps.changed-files.outputs.all_changed_files, '.md')
      run: |
        echo "Markdown files changed: ${{ steps.changed-files.outputs.all_changed_files }}"
        yarn check:docs
        yarn check:docs:size
        yarn lint:md
        
    - name: TypeScript validation
      if: steps.changed-files.outputs.any_changed == 'true' && (contains(steps.changed-files.outputs.all_changed_files, '.ts') || contains(steps.changed-files.outputs.all_changed_files, '.tsx'))
      run: |
        echo "TypeScript files changed: ${{ steps.changed-files.outputs.all_changed_files }}"
        npx tsc --noEmit
        
    - name: PR quality check summary
      run: |
        echo "✅ Pull Request validation completed successfully"
        echo "📝 Files validated: ${{ steps.changed-files.outputs.all_changed_files }}"
        
  block-bypass-commits:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Check for bypass patterns
      run: |
        # 危険なコミットパターンをチェック
        if git log --oneline origin/main..HEAD | grep -i "no-verify\|lefthook=0\|skip.*hook"; then
          echo "❌ ERROR: Detected commits that may have bypassed pre-commit hooks"
          echo "Please ensure all commits follow proper validation procedures"
          exit 1
        fi
        
        # 自動生成っぽいコミットメッセージをチェック
        if git log --oneline origin/main..HEAD | grep -E "^[a-f0-9]+ Write .*\.(md|ts|tsx)$"; then
          echo "⚠️  WARNING: Detected automated commit messages"
          echo "Please verify these commits passed proper validation"
        fi
        
        echo "✅ No problematic commit patterns detected"