name: Pull Request Validation

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened, ready_for_review ]

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # PRã®å…¨ã¦ã®å¤‰æ›´ã‚’å–å¾—ã™ã‚‹ãŸã‚
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'yarn'
        
    - name: Install dependencies
      run: yarn install --frozen-lockfile
      
    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v41
      with:
        files: |
          **/*.md
          **/*.ts
          **/*.tsx
          **/*.js
          **/*.jsx
          
    - name: Validate markdown files
      if: steps.changed-files.outputs.any_changed == 'true' && contains(steps.changed-files.outputs.all_changed_files, '.md')
      run: |
        echo "Markdown files changed: ${{ steps.changed-files.outputs.all_changed_files }}"
        yarn check:docs
        yarn check:docs:size
        yarn lint:md
        
    - name: TypeScript validation
      if: steps.changed-files.outputs.any_changed == 'true' && (contains(steps.changed-files.outputs.all_changed_files, '.ts') || contains(steps.changed-files.outputs.all_changed_files, '.tsx'))
      run: |
        echo "TypeScript files changed: ${{ steps.changed-files.outputs.all_changed_files }}"
        npx tsc --noEmit
        
    - name: PR quality check summary
      run: |
        echo "âœ… Pull Request validation completed successfully"
        echo "ğŸ“ Files validated: ${{ steps.changed-files.outputs.all_changed_files }}"
        
  block-bypass-commits:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Check for bypass patterns
      run: |
        # å±é™ºãªã‚³ãƒŸãƒƒãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
        if git log --oneline origin/main..HEAD | grep -i "no-verify\|lefthook=0\|skip.*hook"; then
          echo "âŒ ERROR: Detected commits that may have bypassed pre-commit hooks"
          echo "Please ensure all commits follow proper validation procedures"
          exit 1
        fi
        
        # è‡ªå‹•ç”Ÿæˆã£ã½ã„ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯
        if git log --oneline origin/main..HEAD | grep -E "^[a-f0-9]+ Write .*\.(md|ts|tsx)$"; then
          echo "âš ï¸  WARNING: Detected automated commit messages"
          echo "Please verify these commits passed proper validation"
        fi
        
        echo "âœ… No problematic commit patterns detected"