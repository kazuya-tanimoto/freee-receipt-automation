# freee経費管理自動化システム - 改訂要件とアーキテクチャ

## 目的

フリーランスの経費管理と領収書紐付けを自動化し、確定申告と経理作業の効率を大幅に向上させるシステムを構築します。

## 要件

### 1. 基本機能

- freeeで管理している経費と領収書（PDFファイル）の自動紐付け
- 取引（経費）への適切な添付書類の自動付与
- 処理結果の確認と手動調整のための管理インターフェース
- 月次領収書フォルダの自動作成とPDF管理

### 2. ユーザー手動作業

- **領収書準備**:
  - 楽天/Amazon: ユーザーが会員ページからPDFをダウンロードして指定フォルダに保存
  - 紙の領収書（ガソリンなど）: ユーザーがスキャンアプリでOCR対応のPDFに変換して指定フォルダに保存
- **結果確認**:
  - 通知メールの確認
  - 必要に応じて管理インターフェースでの詳細確認と手動修正

### 3. 自動化対象

- **領収書処理**:
  - 指定ディレクトリに保存された領収書PDFの処理
  - メール領収書（AppleサブスクリプションなどのPDF領収書）: Gmail APIを使用して取得・処理
  - 月次フォルダ構造の自動作成と適切なPDF保存
- **取引処理**:
  - OCRによる領収書からの情報抽出
  - ルールベースの照合処理（修正履歴からの自動改善）
  - freee APIを使用した紐付け、コメント追加、項目設定
- **通知**:
  - 処理結果をユーザー指定のメールアドレスに送信

### 4. PDFファイル管理要件

- 短いファイル名（主に商品名のみ）
- 重複時の番号付与（例："\_2.pdf"）
- 既存のフォルダ構造に従った保存形式（例：`/01.領収書/MM/filename.pdf`）
- Google Driveへの保存（APIアクセス性と認証の観点から推奨）

### 5. 定期実行要件

- 週次の自動バックグラウンド処理
- ログ保存とエラー通知
- 最小コストでの運用

## システムアーキテクチャ

### 1. 技術スタック

- **バックエンド**: Supabase（PostgreSQL + Edge Functions）
- **フロントエンド**: NextJS（サーバーサイド処理に有利）
- **ストレージ**: Supabase Storage + Google Drive連携
- **定期実行**: Supabase pg_cron
- **OCR処理**: Google Cloud Vision API
- **通知**: メールサービス（SendGridなど、可能な限りSupabase機能を活用）

### 2. システム構成

```text
[ユーザー側]
  ├── 領収書PDFのダウンロード → 指定フォルダに保存
  ├── 紙の領収書のスキャン → PDF変換 → 指定フォルダに保存
  └── 結果の確認（メール/管理画面）と手動修正
  ↓
[Supabase Storage（一時保存）]
  PDFファイル処理
  ↓
[Edge Functions + pg_cron]
  ├── PDF検出 → OCR処理 → 情報抽出
  ├── Gmail API経由のメール取得 → PDF変換 → 情報抽出
  ├── ルールベースの照合処理
  ├── freee API連携（取引取得、照合、更新）
  ├── Google Driveへの整理されたファイル保存
  └── 処理結果のメール通知
  ↓
[PostgreSQL]
  ├── 処理結果と照合情報の保存
  ├── 照合ルールデータベース
  └── ユーザー修正データの蓄積と自動ルール生成
  ↓
[NextJS管理画面]
  ├── 処理状況の確認
  ├── 手動調整と修正
  └── 照合結果のフィードバック
```

### 3. ユーザーフロー

1. **初期設定**:

   - freee API認証設定
   - Gmail API連携設定
   - Google Drive連携設定
   - 通知メールアドレス設定

2. **日常利用**:
   - 楽天/Amazon領収書: 会員ページからダウンロードして指定フォルダに保存
   - 紙の領収書: スキャンアプリでPDFに変換して指定フォルダに保存
   - 自動処理: システムが週次で処理
   - 通知: 処理結果をメールで送信
   - 確認/修正: 管理画面で詳細確認と手動調整

## 実装詳細

### 1. OCR処理

- PDF文書からのテキスト抽出
- 構造化データへの変換（日付、金額、店舗名、項目など）
- 特定パターン（Apple、Amazonなど）のカスタム処理

### 2. ルールベースの照合ロジック

- 日付照合（±数日の許容範囲）
- 金額照合（完全一致または近似）
- 店舗名と内容による補助照合
- **修正履歴ベースのルール適用**:
  - ユーザー修正パターンをデータベースに蓄積
  - 「店舗X」→「freee項目Y」のマッピングルール
  - 「特定キーワード」→「特定カテゴリ」の分類ルール
  - ルール適用優先度の自動調整（頻度ベース）
- 複数候補の優先順位設定

### 3. フォルダ管理

- 既存構造の維持（`/01.領収書/MM/filename.pdf`）
- 短いファイル名の割り当て（主に商品名のみ）
- 重複ファイル名の自動番号付与（\_2.pdf、\_3.pdfなど）
- Google Driveへの適切な配置

### 4. 管理画面

- ダッシュボード: 処理状況の概要
- リスト表示: 領収書と取引の照合状況
- 詳細表示: 個別の取引/領収書の閲覧
- 修正機能: 手動照合、再処理、例外処理
- **ルール管理**: 生成されたルールの確認と編集

### 5. 通知機能

- 処理完了時のサマリーメール
- エラー時の詳細通知
- 未処理項目の一覧

## 開発計画

**重要**: このプランは3回の失敗を踏まえTooMuch回避を最優先に2フェーズで設計されています。

### フェーズ1: 基盤構築（PBI-1-01～1-13）✅完了済み

**目的**: レシート処理に必要なライブラリとAPI連携の完全実装

**実装内容**:
- PBI-1-01～03: Next.js 15.4 + Supabase基本設定
- PBI-1-04～06: Gmail OAuth + メール検索 + PDF抽出
- PBI-1-07～09: Google Vision OCR + テキスト解析
- PBI-1-10～13: freee OAuth + 取引取得 + マッチング + 経費登録

**成果物**: 各機能の完全なライブラリ実装完了

### フェーズ2: UI・統合・自動化（PBI-2-01～2-08）

**目的**: 実用的なシステム完成とMVP達成

**実装内容**:

#### 📊 **MVP達成PBI（実用化に必須）**:
- PBI-2-04: Edge Function実装（処理オーケストレーション）
- PBI-2-01: 基本ダッシュボードページ（管理UI）
- PBI-2-05: スケジューリング基盤（週次自動実行）

#### 🚀 **拡張機能PBI（MVP後の改善）**:
- PBI-2-02: 処理状況表示コンポーネント
- PBI-2-03: 手動修正フォーム
- PBI-2-06: 実行監視（ログ・エラー追跡）
- PBI-2-07: メール通知機能
- PBI-2-08: Google Drive保存

**成果物**: 週次レシート自動処理の完全稼働システム

### MVP定義の明確化

**フェーズ1完了時点**: ライブラリ基盤完成（まだ実用不可）
**MVP達成時点**: フェーズ1 + MVP達成3PBI完了時（実用化開始）
**フル機能完成**: フェーズ2全PBI完了時（本格運用レベル）

## 必要な外部サービス

- Supabase: バックエンド/ストレージ基盤（無料枠内で運用）
- Google Cloud（Vision API、Gmail API、Drive API）
- SendGridなどのメールサービス（可能な限りSupabase機能を活用）

## コスト見積もり（年間）

### 週4件程度の処理に対する年間コスト見積もり

- **Google Cloud Vision API**: ほぼ無料（無料枠内）
- **Supabase**: 無料枠内（データ量が少ないため）
- **Google APIs（Gmail/Drive）**: 無料枠内
- **SendGrid**: 月25,000通まで無料

### 総コスト見積もり

**基本実装**: **ほぼ無料**から**年間$5**程度（使用量が少ないため）

## 重要な注意点

- コスト効率を重視し、無料枠と低コストオプションに焦点
- 週次処理要件に基づくリソース消費の最小化
- データ保護とプライバシーへの配慮（個人の領収書情報の取り扱い）
- ルールベースの自動改善による自己進化メカニズムの構築

このアーキテクチャにより、領収書管理から取引紐付けまでを大幅に自動化し、確定申告と経理作業の効率を向上させることができます。また、ユーザーの修正から自動的にルールを生成・蓄積することで、低コストを維持しながら時間の経過とともに精度を向上させることができます。
