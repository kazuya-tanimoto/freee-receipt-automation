# freee経費管理自動化システム - 改訂要件と構成案

## 目的
フリーランスの経費管理と領収書の紐付けを自動化し、確定申告や帳簿管理の効率を大幅に向上させるシステムを構築します。

## 要件

### 1. 基本機能
* freeeで管理している経費と領収書（PDFファイル）を自動で紐づけ
* 取引（支出）に対して適切な証憑書類を自動添付
* 処理結果の確認と必要に応じた手動調整ができる管理画面
* 領収書の月別フォルダ自動作成とPDF管理

### 2. ユーザーの手動操作
* **領収書の準備**:
  * 楽天・Amazon: ユーザーがマイページからPDFをダウンロードし、指定フォルダに保存
  * ガソリン等の紙レシート: ユーザーがスキャンアプリでOCR処理しやすい形でPDF化し、指定フォルダに保存
* **処理結果の確認**:
  * 通知メールの確認
  * 必要に応じて管理画面での詳細確認と手動修正

### 3. 自動化対象
* **領収書処理**:
  * 指定ディレクトリに格納された領収書PDFの処理
  * メール領収書(AppleサブスクリプションなどのPDF領収書): Gmail APIで取得・処理
  * 月別フォルダ構造の自動作成とPDFの適切な格納
* **取引処理**:
  * OCR処理による領収書からの情報抽出
  * ルールベースのマッチング処理（修正履歴から自動改善）
  * freee APIを通じた取引への紐付け・コメント追加・品目設定
* **通知**:
  * 処理結果をユーザー指定のメールアドレスに通知

### 4. PDFファイル管理要件
* 短いファイル名（主に商品名のみ）
* 重複する場合は「_2.pdf」などの番号付加
* 既存のフォルダ構成を踏襲した保存形式（例：`/01.領収書/MM/ファイル名.pdf`）
* GoogleDriveでの保管（APIアクセス性と認証の容易さから推奨）

### 5. 定期実行要件
* 週次程度での自動バックグラウンド処理
* 処理結果のログ保存とエラー通知
* 最小限のコストでの運用

## システム構成案

### 1. 技術スタック
* **バックエンド**：Supabase (PostgreSQL + Edge Functions)
* **フロントエンド**：NextJS (サーバーサイド処理に有利)
* **ストレージ**：Supabase Storage + GoogleDrive連携
* **定期実行**：Supabase pg_cron
* **OCR処理**：Google Cloud Vision API
* **通知**：メール送信サービス（SendGrid等、可能ならSupabaseの機能を活用）

### 2. システムアーキテクチャ

```
[ユーザー側]
  ├── 領収書PDFのダウンロード → 指定フォルダに保存
  ├── 紙レシートのスキャン → PDF化 → 指定フォルダに保存
  └── 処理結果の確認（メール・管理画面）・手動修正
  ↓
[Supabase Storage (一時保存)]
  PDFファイル処理
  ↓
[Edge Functions + pg_cron]
  ├── PDF検出 → OCR処理 → 情報抽出
  ├── Gmail APIからメール取得 → PDF変換 → 情報抽出
  ├── ルールベースマッチング処理
  ├── freee API連携（取引取得・マッチング・更新）
  ├── GoogleDriveへのファイル整理保存
  └── 処理結果メール通知
  ↓
[PostgreSQL]
  ├── 処理結果・マッチング情報の保存
  ├── マッチングルールのDB
  └── ユーザー修正データの蓄積・ルール自動生成
  ↓
[NextJS管理画面]
  ├── 処理状況確認
  ├── 手動調整・修正
  └── マッチング結果のフィードバック
```

### 3. ユーザーフロー

1. **初期設定**:
   * freee API認証設定
   * Gmail API連携設定
   * GoogleDrive連携設定
   * 通知先メールアドレス設定

2. **日常利用**:
   * 楽天・Amazon領収書：マイページからダウンロードして指定フォルダに保存
   * 紙レシート：スキャンアプリでPDF化して指定フォルダに保存
   * 自動処理：システムが週次で処理
   * 通知：処理結果がメールで届く
   * 確認・修正：必要に応じて管理画面で詳細確認・手動調整

## 実装詳細

### 1. OCR処理
* PDF文書のテキスト抽出
* 構造化データへの変換（日付、金額、店舗名、品目など）
* 特定パターン（AppleやAmazonなど）に対するカスタム処理

### 2. ルールベースマッチングロジック
* 日付一致（±数日の許容範囲あり）
* 金額一致（完全一致または近似値）
* 店舗名・内容による補助的マッチング
* **修正履歴ベースのルール適用**：
  * ユーザーの修正パターンをDBに蓄積
  * 「店舗名X」→「freee品目Y」のマッピングルール
  * 「特定キーワード」→「特定カテゴリ」の分類ルール
  * ルールの適用優先順位の自動調整（頻度ベース）
* 複数候補がある場合の優先度設定

### 3. フォルダ管理
* 既存構造の踏襲（`/01.領収書/MM/ファイル名.pdf`）
* 短いファイル名付与（主に商品名のみ）
* 重複ファイル名の自動ナンバリング（_2.pdf, _3.pdf など）
* GoogleDriveへの適切な配置

### 4. 管理画面
* ダッシュボード：処理状況の概要
* 一覧表示：領収書と取引のマッチング状況
* 詳細画面：個別取引・領収書の閲覧
* 修正機能：手動マッチング、再処理、例外処理
* **修正ルール管理**：生成されたルールの確認・編集機能

### 5. 通知機能
* 処理完了時のサマリーメール
* エラー発生時の詳細通知
* 未処理項目のリスト化

## 開発計画

### フェーズ1：基本機能実装
* Supabaseプロジェクト設定
* ストレージ連携とOCR処理実装
* freee API連携基本機能

### フェーズ2：自動化機能実装
* Gmail API連携
* GoogleDrive連携
* フォルダ・ファイル管理機能
* 定期実行設定

### フェーズ3：管理UI実装
* NextJSベースの管理画面
* マッチング状況確認機能
* 手動調整機能

### フェーズ4：通知と基本マッチング改善
* メール通知機能
* OCR精度向上
* 基本マッチングアルゴリズム改良

### フェーズ5：ルールベース学習機能（後期）
* ユーザー修正データの収集機能
* 修正履歴からのルール自動生成機能
* ルールベースマッチングエンジンの実装

## 必要な外部サービス
* Supabase：バックエンド・ストレージ基盤（極力無料枠内での運用）
* Google Cloud（Vision API、Gmail API、Drive API）
* SendGrid等のメール送信サービス（可能ならSupabaseの機能で代替）

## 費用見積もり（年間）

### 週4件程度の処理量で想定される年間費用
* **Google Cloud Vision API**：ほぼ無料（無料枠内）
* **Supabase**：無料枠内（データ量が少ないため）
* **Google APIs（Gmail/Drive）**：無料枠内
* **SendGrid**：月25,000通まで無料

### 総合費用見積もり
**基本実装**：**ほぼ無料**～**$5/年**（極小規模利用のため）

## 注意事項
* コスト効率を重視し、無料枠や低コストオプションを優先
* 週次処理で十分な要件を踏まえ、必要最小限のリソース消費に抑制
* データ保護とプライバシー考慮（個人の領収書情報を扱うため）
* ルールベースの自動改善で自己進化する仕組みを構築

この構成により、領収書の管理から取引への紐付けまでを大幅に自動化し、確定申告や帳簿管理の効率を向上させることができます。また、ユーザーが行った修正内容からルールを自動生成・蓄積することで、コストを抑えつつも時間とともにシステムの精度が向上していく仕組みを実現します。