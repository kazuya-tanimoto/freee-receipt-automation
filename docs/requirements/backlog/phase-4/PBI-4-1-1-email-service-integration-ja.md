# PBI-4-1-1: メールサービス統合と設定

## 説明

SendGrid APIによる信頼性のあるメール配信を、Supabaseデータベースキューと基本的な配信追跡機能とともに実装します。

## 実装詳細

### 作成/修正するファイル

1. `src/lib/email/client.ts` - メールサービスクライアント設定
2. `src/lib/email/types.ts` - メールサービス型定義
3. `src/lib/email/delivery.ts` - メール配信管理
4. `src/lib/email/tracking.ts` - 配信追跡とステータス監視
5. `src/config/email.ts` - メールサービス設定
6. `.env.local.example` - メールサービス環境変数
7. `src/services/email/EmailService.ts` - メインメールサービスクラス

### 技術要件

- SendGrid API統合（v7+、APIベースのみ）
- Supabaseデータベースキューによるメール処理
- 基本的な配信ステータス追跡
- シンプルなレート制限（SendGrid API制限）
- 基本的なバウンスと苦情処理
- メール認証（SPF、DKIM、DMARC）
- 環境固有設定（dev/staging/prod）

### セキュリティ考慮事項

- APIキーの安全な保存とローテーション
- Webhook署名検証
- 悪用防止のためのレート制限
- メールアドレス検証とサニタイゼーション
- SPF/DKIM/DMARC認証設定

### パフォーマンス最適化

- データベースベースのメールキュー
- 非同期メール送信
- 基本的な配信ステータスキャッシュ
- シンプルな再試行メカニズム（最大3回）

## メタデータ

- **ステータス**: 未開始
- **作成日**: 2025-01-13
- **担当者**: AIアシスタント
- **レビュー担当者**: 人間の開発者

## 受け入れ基準

- [ ] メールサービスプロバイダーが正常に統合される
- [ ] メール送信機能が確実に動作する
- [ ] 配信ステータス追跡が稼働する
- [ ] レート制限がサービス悪用を防止する
- [ ] バウンスと苦情処理が正しく動作する
- [ ] メール認証が適切に設定される
- [ ] 環境変数が適切に設定される

## 依存関係

- **必須**: PBI-1-1 - Supabaseプロジェクト設定（設定保存用）

## テスト要件

- Unit Tests (Vitest): メールサービスクライアント、配信追跡、設定
- Integration Tests (Testing Library): メール送信フロー、Webhook処理
- E2E Tests (Playwright): 完全なメール配信ワークフロー
- Load Tests: 高負荷下でのレート制限とキューパフォーマンス

## 見積もり

1 ストーリーポイント

## 優先度

高 - 全メール通知機能の基盤
