# PBI-1-1-5: 認証設定

## 説明

freeeレシート自動化アプリケーションの認証システムを設定します。これには、メール/パスワード認証の設定、認証ヘルパー関数の作成、およびNext.jsミドルウェアによるセッション管理の実装が含まれます。

## 実装詳細

### 作成/修正するファイル

1. `src/lib/auth/index.ts` - 認証ヘルパー関数
2. `src/middleware.ts` - 保護されたルート用のNext.jsミドルウェア
3. `src/lib/auth/session.ts` - セッション管理ユーティリティ
4. `src/components/auth/AuthProvider.tsx` - 認証状態用のReactコンテキスト
5. `src/hooks/useAuth.ts` - 認証用のカスタムフック

### 技術要件

- Supabaseでメール/パスワード認証を設定
- JWTトークンリフレッシュメカニズムを実装
- 保護されたルートのミドルウェアを設定
- セッション有効期限を設定（7日間）
- 適切なエラーハンドリングを実装

### APIエンドポイント

- `POST /api/auth/login` - ユーザーログイン
  - リクエストボディ: `{ email: string, password: string }`
  - レスポンス: `{ user: User, session: Session }`
- `POST /api/auth/logout` - ユーザーログアウト
  - レスポンス: `{ success: boolean }`
- `POST /api/auth/refresh` - セッションリフレッシュ
  - レスポンス: `{ session: Session }`

### 従うべきコードパターン

- 認証状態管理にReact Contextを使用
- ルート保護にミドルウェアパターンを実装
- ユーザーとセッションに適切なTypeScript型を使用
- Next.js App Routerの規約に従う

## 受け入れ基準

- [ ] ユーザーがメール/パスワードでサインアップできる
- [ ] ユーザーがログインしてセッションを受け取れる
- [ ] 保護されたルートが認証されていない場合にログインにリダイレクトする
- [ ] ブラウザのリフレッシュ後もセッションが保持される
- [ ] ログアウトが適切にセッションをクリアする

## 依存関係

- **必須**: PBI-1-1-1 - Supabaseプロジェクトが初期化されている必要
- **必須**: PBI-1-1-2 - ユーザー設定テーブルが存在する必要

## テスト要件

- ユニットテスト: 認証ヘルパー関数をテスト
- 統合テスト: ログイン/ログアウトフローをテスト
- テストデータ: 異なるロールを持つテストユーザーアカウント

## 見積もり

1ストーリーポイント

## 優先度

高 - すべてのユーザー機能に必要なコア認証

## 実装メモ

- ReactコンポーネントでSupabase Authフックを使用
- セキュリティのために適切なPKCEフローを実装
- 将来のフェーズでソーシャル認証の実装を検討
