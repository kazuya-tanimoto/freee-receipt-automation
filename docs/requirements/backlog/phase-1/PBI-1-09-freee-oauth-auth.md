# PBI-1-09: freee OAuth認証

## 説明

freee API アクセス用のOAuth 2.0認証フローを実装します。経費データアクセスに必要な最小限のスコープでfreee APIへの認証を行い、トークン管理を含む基本的な認証機能を提供します。

## 実装詳細

### 作成/修正するファイル

1. `src/lib/freee-auth.ts` - freee OAuth認証処理（80行以内）
2. `pages/api/auth/freee.ts` - freee認証APIエンドポイント（20行以内）

### 技術要件

- freee OAuth 2.0 フロー
- read_write スコープ設定
- トークンのセキュアな保存
- リフレッシュトークン対応

### 環境変数

```bash
# PBI-1-03で設定済み
FREEE_CLIENT_ID=your_freee_client_id
FREEE_CLIENT_SECRET=your_freee_client_secret
FREEE_REDIRECT_URI=http://localhost:3000/api/auth/freee/callback
```

### インターフェース仕様

```typescript
interface FreeeAuthConfig {
  clientId: string;
  clientSecret: string;
  redirectUri: string;
}

interface FreeeTokens {
  access_token: string;
  refresh_token?: string;
  expires_in: number;
  company_id: number;
}
```

## 🎯 実装前チェックリスト（影響範囲分析）

- [x] **影響範囲確認**: PBI-1-08完了後に実施、他への影響なし
- [x] **依存関係確認**: PBI-1-03（環境変数設定）完了が前提
- [x] **spec要件確認**: freee連携がspec必須要件
- [x] **リソース確認**: freee アプリケーション登録済み

## 🔧 実装ガイドライン

### TooMuch回避指針
- **行数制限**: 認証処理80行以内
- **単一責任**: freee認証のみ、データ取得は含まない
- **直接実装**: 認証ライブラリの複雑な機能は使用しない

### コード品質基準
- **TypeScript**: 型安全な認証フロー
- **エラーハンドリング**: 認証失敗時の明確なエラー
- **JSDoc**: OAuth関数の説明記載

## 受け入れ基準

- [ ] freee OAuth認証フローが正常に動作する
- [ ] アクセストークンが正しく取得される
- [ ] 会社IDが適切に管理される
- [ ] TypeScriptエラーがない

### 検証コマンド

```bash
# TypeScript検証
yarn tsc --noEmit

# Lintチェック（Biome）
yarn lint

# テスト実行（Vitest）
yarn test

# 認証テスト
yarn dev
# /api/auth/freee にアクセスして認証フロー確認
```

### Git ワークフロー

**必須手順:**
1. **フィーチャーブランチ作成**: `git checkout -b feature/pbi-1-09-freee-oauth`
2. **実装・テスト・コミット**: 通常のコミット（`--no-verify`禁止）
3. **プッシュ**: `git push -u origin feature/pbi-1-09-freee-oauth`
4. **PR作成**: GitHub UIまたは`gh pr create`
5. **レビュー・マージ**: コンフリクトなしの場合は自動マージ可

## 🚨 実装完了後の必須作業

**技術実装完了後に必ず実行すること:**

1. **セルフレビューチェックボックス記入**
   - 「実装完了時必須チェック」の全項目を[x]に変更
   - 「第三者視点コードレビュー観点」の全項目を[x]に変更

2. **完了報告テンプレート記入**
   - TypeScript・テスト・ドキュメント・影響範囲の結果を正確に記入
   - 実装サマリーを具体的に記載

3. **メタデータ更新**
   - ステータスを「完了」に変更
   - 実際のストーリーポイントを記入
   - 開始日・完了日・担当者・実装メモを記入

4. **進捗管理コミット**
   - 上記変更をコミットして進捗を正式に記録

5. **外部レビュー依頼**
   - 以下のレビュー依頼文をコピペして他のAIにレビューを依頼

```
## PBI実装レビュー依頼

### レビュー対象
- **プロジェクト**: freeeレシート自動化システム
- **PBI**: [PBI番号と名称]
- **実装内容**: [実装した機能の概要]

### レビュー観点
以下の観点で客観的なレビューをお願いします：

#### 1. 技術品質
- [ ] TypeScript型安全性とエラーハンドリング
- [ ] テストカバレッジと品質
- [ ] コード可読性と保守性
- [ ] セキュリティ考慮事項

#### 2. アーキテクチャ適合性
- [ ] Next.js 15.4 + React 19 ベストプラクティス準拠
- [ ] プロジェクト構造との整合性
- [ ] 依存関係の適切性

#### 3. 要件適合性
- [ ] PBI受け入れ基準100%達成
- [ ] spec要件との整合性
- [ ] TooMuch回避原則遵守

#### 4. 運用品質
- [ ] エラー処理とログ出力
- [ ] パフォーマンス影響
- [ ] 将来の拡張性

### 確認対象ファイル
```
[実装したファイルのパスを列挙]
```

### 実行確認
```bash
# TypeScript検証
yarn tsc --noEmit

# テスト実行
yarn test:run

# 動作確認
yarn dev
```

```

**⚠️ 重要**: この作業を怠ると進捗追跡ができなくなります

**禁止事項:**
- ❌ **mainブランチへの直接コミット** - 必ずフィーチャーブランチを使用
- ❌ **`--no-verify`フラグ使用** - pre-commitチェックは必須
- ❌ **コンフリクト状態でのマージ** - 解決後に再実行

**コミットメッセージ規約:**
```
feat: PBI-1-09 freee OAuth authentication

- Implement freee OAuth 2.0 flow
- Add company-specific token management
- Set up secure expense API authentication
```

## ✅ プロフェッショナルセルフレビュー

### 実装完了時必須チェック
- [ ] **影響範囲**: 既存PBIへの悪影響なし
- [ ] **要件達成**: freee OAuth認証が完了している
- [ ] **シンプル化**: 必要最小限の認証機能のみ
- [ ] **テスト**: 認証フローテストがパスしている
- [ ] **型安全性**: TypeScript型チェックが正しく動作している

### 第三者視点コードレビュー観点
- [ ] **可読性**: 認証コードが理解しやすい
- [ ] **保守性**: トークン管理が適切に設計されている
- [ ] **セキュリティ**: OAuth フローが安全に実装されている
- [ ] **パフォーマンス**: 不要な認証処理がない

## 📋 完了報告テンプレート

### ✅ セルフチェック結果
- TypeScript: ✅ 0エラー / ❌ Xエラー
- テスト: ✅ 認証フローテストパス / ❌ X失敗  
- ドキュメント: ✅ OAuth設定説明完備 / ❌ 不足
- 影響範囲: ✅ 他PBI機能に悪影響なし

### 実装サマリー
- **達成した価値**: freee経費データアクセスへの認証基盤が確立された
- **主要な実装**: freee OAuth 2.0認証フローとトークン管理
- **残課題**: なし
- **次PBIへの引き継ぎ**: freee APIアクセス用認証が他PBIで使用可能

## メタデータ
### 進捗記入欄
- **ステータス**: 未開始
- **実際のストーリーポイント**: [完了後に記入]
- **作成日**: 2025-07-28
- **開始日**: [日付]
- **完了日**: [日付]
- **担当者**: [AIアシスタントIDまたは人間]
- **レビュアー**: [このPBIをレビューした人]
- **実装メモ**: [完了後の学び]

### レビュー結果記入欄
- **総合判定**: ✅承認 / ❌要修正
- **主要な問題**:
- **改善提案**:
- **品質スコア**: [1-5点]
- **コメント**: