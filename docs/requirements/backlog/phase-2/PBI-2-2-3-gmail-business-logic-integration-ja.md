# PBI-2-2-3: Gmailビジネスロジック統合

## 説明

Gmail操作を領収書処理ワークフローのコアビジネスロジックと統合します。
これには、領収書のメール検索、添付ファイルの抽出、メタデータの解析、
およびシームレスなメールから領収書へのパイプラインを作成するためのOCR処理との
調整が含まれます。

## 実装詳細

### 作成/修正するファイル

1. `src/services/gmail-receipt-processor.ts` - メイン メール処理サービス
2. `src/lib/gmail/receipt-finder.ts` - 領収書メール識別
3. `src/lib/gmail/attachment-handler.ts` - 添付ファイル抽出ロジック
4. `src/lib/gmail/email-parser.ts` - メールコンテンツ解析
5. `src/services/gmail-workflow.ts` - 完全なGmailワークフロー
6. `docs/gmail/business-logic.md` - ビジネスロジックドキュメント

### 技術要件

- 領収書パターンでメールを検索
- PDFと画像の添付ファイルを抽出
- 領収書情報のメールメタデータを解析
- OCR処理のために添付ファイルをキューに入れる
- 重複を避けるため処理済みメールをマーク

### 実装コード

- 領収書メール識別ロジック
- 添付ファイル抽出実装
- メール解析ユーティリティ
- ワークフローオーケストレーション
- 処理状態管理

## メタデータ

- **ステータス**: 未開始
- **実際のストーリーポイント**: [完了後に記入]
- **作成日**: 2025-06-05
- **開始日**: [日付]
- **完了日**: [日付]
- **所有者**: [AIアシスタントIDまたは人間]
- **レビュアー**: [このPBIをレビューした人]
- **実装メモ**: [完了後の学び]

## 受け入れ基準

- [ ] 領収書メールが正しく識別される
- [ ] 添付ファイルが正常に抽出される
- [ ] メールメタデータが正確に解析される
- [ ] 添付ファイルのOCR処理がトリガーされる
- [ ] 処理済みメールが再処理を防ぐためマークされる
- [ ] ワークフローがすべてのメールタイプを処理する

## 依存関係

- **必須**: PBI-2-2-1 - Gmail OAuth設定
- **必須**: PBI-2-2-2 - Gmail基本API操作
- **必須**: OCR処理インフラストラクチャ

## テスト要件

- ユニットテスト: メール解析ロジック
- 統合テスト: 完全なメール処理フロー
- パフォーマンステスト: 一括メール処理
- エッジケース: 様々なメール形式と添付ファイル

## 見積もり

2ストーリーポイント

## 優先度

高 - メール処理のコアビジネスロジック
