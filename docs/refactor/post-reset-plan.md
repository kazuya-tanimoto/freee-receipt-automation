# TooMuch排除後の今後実装プラン

## 現状総括

### プロジェクトリセットの成果
- **削除済み**: src/全体 (7,883行)、複雑なDB設計、エンタープライズパターン
- **完全クリーンアップ完了**: 古いライブラリ設定・競合設定ファイルを100%排除
- **保持済み**: docs/ フォルダ（計画文書）、CLAUDE.md、.mcp.json のみ
- **現在のコード規模**: 61,662行 → **完全ゼロ**（100%クリーン達成）

### ⚠️ 重要: リセット後の実装方針

**現在のリポジトリ状況**:
- 過去の実装ファイル: **完全削除済み**
- 設定ファイル: **競合要因を100%排除**
- 実装開始: **PBI-1-01から完全新規構築**

**実装時の注意**:
- 既存ファイルに惑わされない（存在しない）
- docs/記載の技術スタックで新規構築
- 過去の設定を参考にしない

### ユーザー要望の再確認
「週4通のレシート処理を自動化するfreee連携システム」
- **自動実行**: pg_cronによる週次バックグラウンド処理
- **管理UI**: NextJS、処理結果確認・修正画面
- **運用コスト**: 年間$5以下

## spec準拠MVP定義

### 必須機能（spec要件）
1. **自動レシート処理**
   - Gmail API経由でメール取得（Apple課金等）
   - 手動配置PDF処理（Amazon、楽天等）
   - OCR実行（Google Vision API）

2. **freee連携**
   - API経由で取引データ取得
   - 金額・日付マッチング
   - 自動経費登録・領収書添付

3. **管理UI** ⭐️ 必須要件
   - 処理状況確認画面
   - 手動修正機能
   - ダッシュボード

4. **自動実行** ⭐️ 必須要件
   - 週次実行（pg_cron）
   - メール通知
   - エラーハンドリング

5. **ファイル管理**
   - Google Drive保存
   - 月別フォルダ構成
   - 短縮ファイル名

## ミニマムPBI構造（20個のPBI）

### 理由
- AIの作業品質維持のため、1PBIの責務を最小化
- 小さいPBIは問題なし、大きいPBIはTooMuchリスク
- 94%のPBIが単一責務で適切、1個のPBIのみ分割推奨

### Phase 1: 基盤構築（12個のPBI）
```
PBI-1-01: Next.js 15.4 + React 19プロジェクト初期化
PBI-1-02: Supabaseプロジェクト設定
PBI-1-03: 基本環境変数・設定ファイル
PBI-1-04: Gmail OAuth認証
PBI-1-05: Gmail メール検索・取得
PBI-1-06: PDF添付ファイル抽出
PBI-1-07: Google Vision API OCRセットアップ
PBI-1-08: OCRテキスト解析・パース
PBI-1-09: freee OAuth認証
PBI-1-10: freee 取引データ取得
PBI-1-11: マッチングロジック（金額・日付）
PBI-1-12: freee 経費登録API
```

### Phase 2: UI・自動化（8個のPBI）
```
PBI-2-01: 基本ダッシュボードページ
PBI-2-02: 処理状況表示コンポーネント
PBI-2-03: 手動修正フォーム
PBI-2-04: Edge Function実装（処理オーケストレーション）
PBI-2-05: スケジューリング基盤（pg_cron設定）
PBI-2-06: 実行監視（ログ・エラー追跡）
PBI-2-07: メール通知機能
PBI-2-08: Google Drive保存
```

## 実装戦略

### 技術方針
- **ライブラリ**: googleapis、@supabase/supabase-js のみ
- **ファイル制限**: 各PBI 60-120行以内（安全マージン込み）
- **依存関係**: 最小限（Next.js 15.4 + Supabase）
- **開発ツール**: Biome（Lint/Format）、Vitest（テスト）、Lefthook（pre-commit）、Yarn 4.x（パッケージマネージャー）
- **テスト**: Vitest + RTLで重要な関数のみ

### 3回の失敗を避ける設計
1. **小さなコンテキスト**: 1PBI = 1日 = 1人で理解可能
2. **単一責任**: 各ファイルが1つの機能のみ担当
3. **直接実装**: ラッパー、抽象化、パターンを避ける

### データ設計（ミニマム）
```sql
-- 1テーブルのみ
CREATE TABLE processing_logs (
  id UUID PRIMARY KEY,
  email_id TEXT,
  amount DECIMAL,
  date DATE,
  freee_transaction_id TEXT,
  status TEXT, -- pending/matched/failed
  created_at TIMESTAMP
);
```

## 実装スケジュール

### Week 1: Phase 1基盤構築（12日）
```
Day 1-3: 基本セットアップ（PBI-1-01〜03）
Day 4-6: Gmail連携（PBI-1-04〜06）
Day 7-8: OCR処理（PBI-1-07〜08）
Day 9-12: freee連携（PBI-1-09〜12）
```

### Week 2: Phase 2 UI・自動化（8日）
```
Day 13-15: 管理UI（PBI-2-01〜03）
Day 16-18: 自動実行（PBI-2-04〜06）
Day 19-20: 通知・保存（PBI-2-07〜08）
```

### Week 3: 動作確認（3日）
```
Day 21: 実際のレシート1件で動作確認
Day 22: エラー修正・調整
Day 23: 週次実行テスト
```

## 成功の定義

### 動作する最小システム
- Gmail経由でApple課金レシート取得
- OCRで金額・日付抽出
- freeeの未処理取引とマッチング
- 管理UIで結果確認
- 週次自動実行

### 品質基準
- 各ファイル60-120行以内（リスク緩和）
- 単一責務の徹底（TooMuch回避）
- エラー時の停止（フェイルファスト）
- spec要件100%準拠
- 現代的開発ツールの活用

## AIチャット引き継ぎ指針

### 新チャットでの開始方法
1. `docs/refactor/post-reset-plan.md` を読む
2. 上記MVP-PBI構造から開始
3. **TooMuch厳禁**: エンタープライズパターン使用禁止

### 実装時の注意
- specファイルを常に参照
- 100行制限を絶対厳守
- 複雑な依存関係作成禁止
- 「週4通処理」にフォーカス

### 品質確認
```bash
# 必須チェック
find src -name "*.ts" -exec wc -l {} + | sort -n
# 120行超過ファイルがあったら即座に分割
```

---

**重要**: このプランは3回の失敗を踏まえ、「AIの作業品質維持」を最優先に設計している。20個の小さなPBIにより、各PBIが単一責務でAIが混乱しないコンテキストを維持。新機能追加時も必ずこの原則を維持すること。