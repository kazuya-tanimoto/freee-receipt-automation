# AIワークフロールール

## 概要
このドキュメントは、AIアシスタントがfreee-receipt-automationリポジトリ上で作業する際のルールを定義します。

対象読者: AIアシスタント／レビュアー

## 基本原則
### 1. 作業範囲の制限
- AIは明示的に指示されたファイルのみを編集します
- 管理可能性を維持するため、最小限の変更に留めます
- 指示内容を実装する際も、必要最小限のアプローチを採用します
- ガイドライン準拠やセキュリティ確保のための追加作業は許可されます
  - ただし、**実施前に必ず追加理由を説明し、承認を得る必要があります**

### 2. ADR起票
- 影響度が「中」以上の場合は[運用ルールガイドライン](./operational-rules-ja.md)に従い`docs/adr/`へADRを追加すること
- ADR記載項目：
  - 背景
  - 決定事項
  - 影響範囲
  - 代替案
- 影響度「中」の例：
  - 主要ライブラリのメジャーバージョンアップ
  - CI設定の変更
  - アーキテクチャの変更

### 3. レビュープロセス
- 作業完了報告前に必ずセルフレビューを実施します
- 作業完了報告には以下の情報を含めます：
  - セルフレビューの実施状況と結果
  - ユーザーまたは他のAI向けのレビュー依頼文
- レビュー要求タイミング：
  - 変更ファイル数が3ファイル以上
  - 変更行数が合計300行以上
  - 機能単位での区切り
- コミットはレビュー承認後に実行します

### 4. コミット規約
- 既存のコミットメッセージパターンを厳守します
  - 新しいパターンの作成は禁止されています
- コミットメッセージは英語で記述します

#### コミットメッセージ形式
```
<type>: <subject>

<body>

<footer>
```

#### type（必須）
- `feat`: 新機能の追加
- `fix`: バグ修正
- `docs`: ドキュメントのみの変更
- `style`: コードの意味に影響を与えない変更（空白、フォーマット、セミコロンの欠落など）
- `refactor`: バグ修正や機能追加を伴わないコード変更
- `test`: テストの追加または既存テストの修正
- `chore`: ビルドプロセスやドキュメント生成などの補助ツール・ライブラリの変更

#### subject（必須）
- 50文字以内で記述
- 先頭を大文字にしない
- 末尾にピリオドを付けない
- 命令形で記述（例: "change" を使用、"changes" は使用しない）

#### body（オプション）
- 72文字で改行
- 変更内容と理由を説明
- 箇条書きには「-」を使用

### 5. 作業効率
- トークン消費を最小限に抑えるため、簡潔で要点を押さえたレスポンスを心がけます

### 6. 使用ツールの優先順位
- MCPツール使用時は、以下を優先的に使用します：
  - claude_code
  - filesystem
  - git
  - 注：JetBrainsツールの使用を完全に禁止するものではありませんが、上記ツールを優先します

### 7. ドキュメント更新フロー
- 英語版を先に更新し、その後日本語版を更新します
- 両言語版の内容は常に同期を保つようにします

## 作業フロー
### 1. 作業開始前
- 指示内容の確認
- 不明点がある場合の質問
- 追加作業が必要な場合の提案と承認取得
- 影響度の評価とADR起票の必要性確認

### 2. 作業中
- 最小限の変更での対応
- ガイドラインとセキュリティ要件の確認
- 変更内容の記録
- 定期的な進捗確認（ファイル数/行数の閾値チェック）

### 3. 作業完了時
- セルフレビューの実施
- 変更内容の確認
- レビュー依頼文の作成
- 作業完了報告
- 必要に応じてADRの作成

### 4. コミット
- レビュー承認後の実施
- 既存のコミットメッセージ形式の踏襲
- 英語でのメッセージ記述
- CHANGELOGの更新（必要に応じて）

## ロールバック戦略
### 1. 不具合検知時の対応
- 本番環境リリース後に不具合を検知した場合、直近のタグ `v*.*.*` へ `git revert` で戻します
- ロールバック後、**必ず** `CHANGELOG.md` に「Reverted」項目を追加します

### 2. ロールバック手順
- 影響範囲の特定
- ロールバックの実行
- 関係者への通知
- 事後レポートの作成

## 禁止事項
- ユーザーの許可なくコミットを実行すること
- 指示範囲を超えた作業を独断で実施すること
- 新しいコミットメッセージパターンを作成すること
- 不要なトークンを消費すること
- ADRが必要な変更を文書化せずに実施すること

## 例外処理
- セキュリティ上の問題を発見した場合は即座に報告します
- ガイドライン違反を発見した場合は修正提案を行います
- 緊急度の高い問題については優先的に対応提案を行います
- ツールが利用不可能な場合のフォールバック手順を明確にします

## 参考リンク
- [運用ガイドライン](./operational-guidelines-ja.md)
- [運用ルールガイドライン](./operational-rules-ja.md)
- [コーディング規約](../standards/coding-standards-ja.md)
- [プロジェクトのルートREADME](../../README-ja.md)

## 変更履歴
| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|----------|--------|
| 2025-05-31 | 1.0.0 | 初版作成 | AI Assistant |
